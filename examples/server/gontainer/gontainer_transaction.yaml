services:
  transaction:
    scope: "contextual"
    constructor: "pkg.NewTransaction"

  accounts:
    value: "&pkg.Accounts{}"
    fields:
      Transaction: "@transaction"

  users:
    value: "&pkg.Users{}"
    fields:
      Accounts: "@accounts"
      Transaction: "@transaction"

  # define a new handler that is not aware of transactions
  inTransactionHandler:
    constructor: "http.NewInTransactionHandler"
    arguments: [ "@users" ]
    tags: [ "sql.transaction" ]

decorators:
  # decorate all services tagged as "sql.transaction"
  - tag: "sql.transaction"
    decorator: "http.NewTransactionAwareEndpoint"
    arguments: [ "@transaction" ]
